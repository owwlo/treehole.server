<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.css" />
    <link rel="stylesheet" href="./css/jquery.mobile.iscrollview.css"/>
    <link rel="stylesheet" href="./css/jquery.mobile.iscrollview-pull.css"/>
    
	<script src="./js/jquery-2.0.3.js"></script>
	<script src="./js/jquery.mobile-1.3.2.js"></script>
    <script src="./js/jquery.ui.map.full.min.js" type="text/javascript"></script>
    <script src="./js/iscroll.js" type="text/javascript"></script>
    <script src="./js/jquery.mobile.iscrollview.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
    <script>
        var watchID = null;
        var currentPosition;
        var positionListeners = [];
        
        function hideAddressBar(){
  if(document.documentElement.scrollHeight<window.outerHeight/window.devicePixelRatio)
    document.documentElement.style.height=(window.outerHeight/window.devicePixelRatio)+'px';
  setTimeout(window.scrollTo(1,1),0);
}
window.addEventListener("load",function(){hideAddressBar();});
window.addEventListener("orientationchange",function(){hideAddressBar();});
        
        $("a[data-role=tab]").each(function () {
            var anchor = $(this);
            anchor.bind("click", function () {
                $.mobile.changePage(anchor.attr("href"), {
                    transition: "none",
                    changeHash: false
                });
                return false;
            });
        });
        
        $("div[data-role=page]").bind("pagebeforeshow", function (e, data) {
            $.mobile.silentScroll(0);
            $.mobile.changePage.defaults.transition = 'slide';
        });
        
        function clearWatch() {
            if (watchID !== null) {
                navigator.geolocation.clearWatch(watchID);
                watchID = null;
            }
        }
        var wsuccess = function(pos) {
            var text = "Latitude: " + pos.coords.latitude + 
                        " " + "Longitude: " + pos.coords.longitude +
                        "Accuracy: " + pos.coords.accuracy + "m";
            console.log(text);
            currentPosition = pos;
            for(var f in positionListeners) {
                f(pos);
            }
            console.log("listener count:" + positionListeners.length);
        };
        var wfail = function(error) {
            console.log("Error getting geolocation: code=" + error.code + " message=" + error.message);
        };
        var toggleWatchPosition = function() {
            if (watchID) {
                console.log("Stopped watching position");
                clearWatch();
            } else {
                console.log("Watching geolocation . . .");
                var options = { frequency: 3000, maximumAge: 5000, timeout: 5000, enableHighAccuracy: true };
                watchID = navigator.geolocation.watchPosition(wsuccess, wfail, options);
            }
        };
        
        // Watching Geolocation
        $(document).on("ready", function() {
            toggleWatchPosition();
        });
        
        var ROOT_URL = "http://treehole-server.elasticbeanstalk.com";
        var LIST_URL = ROOT_URL + "/list/";
    </script>
    
    <style>
        html,body, div[data-role ="page"] {
            height: 100%;
            width: 100%;
            margin: 0px;
            padding: 0px;
            overflow-y:hidden;
        }
    </style>
    
	<title>SeekIt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

</head>
<body>
    <div data-role="page" id="findings" >
        <script>
            var json_objs_for_finding = [];
            $('#findings').on("pageinit", function() {
                 $.getJSON(LIST_URL + "sadsa", function(data) {
                    console.log(data);
                    var items = [];
                    var i=0;
                    $.each( data, function( key, val ) {
                        console.log(val);
                        var date = new Date(val["time"]);
                        json_objs_for_finding.push(val);
                        var content_cise = val["content"].substring(0, 30) + (val["content"].length>30?"...":"");
                        items.push( "\
                            <li>\
                                <a href='#' onclick='showDetail(" + i +")' data-rel='popup' data-position-to='window' data-transition='pop'>\
                                    <h2>Jesery City, New Jersey, Newport</h2>\
                                    <p>" + content_cise + "</p>\
                                    <p class='ui-li-aside'>" + date.getDate() + "日<strong>" + date.getHours() + ":" + date.getMinutes() + "</strong></p>\
                                </a>\
                            </li>" );
                        i++;
                    });
    //                $.each( data, function( key, val ) {
    //                    console.log(val);
    //                    items.push( "<li><a href='index.html'><h2>Jesery City, New Jersey, Newport</h2><p><strong>test line 1</strong></p><p>test line 2</p><p class='ui-li-aside'>23日<strong>6:24</strong>PM</p></a></li>" );
    //                });
                    $(".it-list").append(items.join(""));
                    $(".it-list").listview('refresh');
                });
            });
            function showDetail(index) {
                var json_obj = json_objs_for_finding[index];
                $("#popup-title").html("Add some HTML!");
                $("#popup-content").html(json_obj["content"]);
                var popupW = Math.round($(window).width()*0.8);
                $("#findings_map").style = "width:" + popupW + "px;height:100px";
                var mapdata = { destination: new google.maps.LatLng(json_obj["lat"], json_obj["lon"]) };
                var mapH = $("#findings_map").height();
                var mapW = $("#findings_map").width();
                $('#findings_map').attr('src', "http://maps.googleapis.com/maps/api/staticmap?center=" + 
                    json_obj["lat"] + "," + json_obj["lon"] + 
                    "&zoom=13&size=" + popupW + "x" + mapH + "&maptype=roadmap&markers=color:red%7C" +
                    json_obj["lat"] + "," + json_obj["lon"] + "&sensor=false");
                $("#popupDialog").popup("open",{transition:"pop"});
            }
            console.log($(window).width()*0.8);
        </script>
        <div data-role="header" data-id="header" data-tap-toggle="false" data-position="fixed" data-theme="c">
            <h1>定位中...</h1>
        </div>
        <div data-role="content" data-iscroll>
            <ul class="it-list" data-role="listview" data-filter="true" data-filter-placeholder="查找宝藏..." data-inset="true">
                <li data-role="list-divider" data-theme="c">10月2013年</li>
            </ul>
        </div>    
        <div data-role="footer" data-id="footer" data-position="fixed" data-tap-toggle="false">
            <div data-role="navbar">
                <ul>
                    <li><a href="#findings" data-role="tab" data-theme="c" class="ui-btn-active ui-state-persist">我的宝藏</a></li>
                    <li><a href="#create" data-role="tab" data-theme="c">埋宝藏</a></li>
                    <li><a href="#mymap" data-role="tab" data-theme="c">我的藏宝图</a></li>
                </ul>
            </div>
        </div>
        <div data-role="popup" id="popupDialog" data-overlay-theme="c" data-theme="c" data-dismissible="false" style="width:100%;max-width:100%;" class="ui-corner-all">
            <div data-role="content" data-theme="c" class="ui-corner-bottom ui-content">
                <img id="findings_map" style="height:100px"></img>
                <p id="popup-content">第二行</p>
                <div style="margin-left:auto; margin-right:0px;">
                    <a href="#" data-role="button" data-mini="true" data-inline="true" data-rel="back" data-transition="flow" data-theme="c">删除</a>
                    <a href="#" data-role="button" data-mini="true" data-inline="true" data-rel="back" data-theme="c">关闭</a>
                </div>
            </div>
        </div>
    </div>
    <div data-role="page" id="create">
        <div data-role="header" data-id="header" data-tap-toggle="false" data-position="fixed" data-theme="c">
            <h1>埋葬我的宝藏</h1>
        </div>
        <div data-role="content" data-iscroll>
            <script>
                var updateTimer;
                var mapdata = { destination: new google.maps.LatLng(59.3327881, 18.064488100000062) };
                $('#create').on("pageshow", function() {
                    $('#map').gmap(
                        { 'center' : mapdata.destination, 
                          'zoom' : 12, 
                          'mapTypeControl' : false, 
                          'navigationControl' : false,
                          'streetViewControl' : false 
                        })
                        .bind('init', function(evt, map) { 
//                            $('#map').gmap('addMarker', 
//                                { 'position': map.getCenter(), 
//                                  'animation' : google.maps.Animation.DROP
//                                });
                        });
//                    updateTimer = setInterval(function(){
//                        $('#map').gmap("clear", "markers");
//                        var coord = new google.maps.LatLng(currentPosition.coords.latitude, currentPosition.coords.longitude);
//                        $('#map').gmap("option", "center", coord);
//                        $('#map').gmap('addMarker', 
//                                { 'position': coord, 
//                                  'animation' : google.maps.Animation.DROP
//                                });
//                    },1000);
                    positionListeners.push(function (pos) {
                        console.log("adasdsdadads"+pos);
                    });
                    
                    $('#map').click( function() { 
                        $.mobile.changePage($('#create'), {});
                    });
                });
            </script>
            <div id="map" style="width:100%;height:200px"></div>
            <textarea name="textarea" id="textarea-a" style="height:300px;max-height: 300px;">
            I'm a basic textarea. If this is pre-populated with content, the height will be automatically adjusted to fit without needing to scroll. That is a pretty handy usability feature.
            </textarea>
            <a href="index.html" data-role="button" data-mini="true" data-icon="delete" data-inline="true">重写</a>
            <a href="index.html" data-role="button" data-mini="true" data-icon="check" data-inline="true" data-theme="c">埋宝藏</a>
        </div>
        <div data-role="footer" data-id="footer" data-position="fixed" data-tap-toggle="false">
            <div data-role="navbar">
                <ul>
                    <li><a href="#findings" data-role="tab" data-theme="c">我的宝藏</a></li>
                    <li><a href="#create" data-role="tab" data-theme="c"  class="ui-btn-active ui-state-persist">埋宝藏</a></li>
                    <li><a href="#mymap" data-role="tab" data-theme="c">我的藏宝图</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div data-role="page" id="mymap">
        <div data-role="header" data-id="header" data-tap-toggle="false" data-position="fixed" data-theme="c">
            <h1>title bar</h1>
        </div>
        <div data-role="content" data-iscroll>
            <h1>未完成</h1>
        </div>
        <div data-role="footer" data-id="footer" data-position="fixed" data-tap-toggle="false">
            <div data-role="navbar">
                <ul>
                    <li><a href="#findings" data-role="tab" data-theme="c">我的宝藏</a></li>
                    <li><a href="#create" data-role="tab" data-theme="c">埋宝藏</a></li>
                    <li><a href="#mymap" data-role="tab" data-theme="c" class="ui-btn-active ui-state-persist">我的藏宝图</a></li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>